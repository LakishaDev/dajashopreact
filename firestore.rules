rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }
    
    // Proverava da li je korisnik ulogovan
    function isAuthenticated() {
      return request.auth != null;
    }

    // Proverava da li je korisnik vlasnik dokumenta (na osnovu UID-a)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Admin ako:
    // 1) ima custom claim `admin: true`  ILI
    // 2) postoji dokument /admins/{uid}
    function isAdmin() {
      return isSignedIn() &&
        (
          request.auth.token.admin == true ||
          exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        );
    }

    // Osnovna validacija proizvoda (tipovi i forma sluga)
    function isNumber(v) { return v is int || v is float; }
    function isBool(v)   { return v is bool; }

    function validProduct(data) {
      return
        // --- Obavezna polja ---
        data.name is string &&
        data.brand is string &&
        data.slug is string &&
        data.slug.matches('^[a-z0-9-]{2,}$') &&
        data.price is number && 
        data.price >= 0 &&

        // --- Opcionalna polja ---
        // Koristimo .get() da proverimo da li polje postoji ili je null pre provere tipa
        (data.get('novo', null) == null || data.novo is bool) &&
        (data.get('images', null) == null || data.images is list);
    }

    // ===== Proizvodi =====
    match /products/{productId} {
      // Svi mogu da čitaju katalog
      allow read: if true;

      // Kreiranje – samo admin + validacija; zahtevamo da id polja odgovara doc id-u
      allow write: if isAdmin() && 
      							validProduct(request.resource.data);

      // Izmena – samo admin + validacija
      allow update: if isAdmin() &&
                    validProduct(request.resource.data);

      // Brisanje – samo admin
      allow delete: if isAdmin();
    }
    
    // 2. PORUDŽBINE (Orders)
    match /orders/{orderId} {
      // Admin vidi sve, Korisnik vidi samo svoje porudžbine (provera po emailu)
      allow read: if isAdmin() || (isSignedIn() && resource.data.customer.email == request.auth.token.email);
      
      // Kreiranje porudžbine dozvoljeno svima (čak i gostima ako aplikacija to podržava)
      // ili samo ulogovanima:
      allow create: if true; 
      
      // Izmena samo od strane admina (statusi itd.)
      allow update, delete: if isAdmin();
    }

    // ===== Admin registar (read samo adminu; write zaključan) =====
    match /admins/{uid} {
      allow read: if isAdmin();
      allow write: if false; // upravljaj preko servera/CLI-a ili Cloud Function-om
    }

    // (Opcionalno) user profili – samo vlasnik čita/piše svoj dokument
    match /users/{uid} {
      allow read, write: if isSignedIn() && request.auth.uid == uid;
      
      match /addresses/{addressId} {
      	allow read: if true;
      	allow write: if isSignedIn();
    	}
      // Podkolekcija: LISTA ŽELJA (Wishlist - priprema za budućnost)
      match /wishlist/{itemId} {
        allow read, write: if isOwner(uid);
      }
    }
    
    // --- 3. Meta podaci (Brendovi, Kategorije, Specifikacije) ---
    // Isto pravilo: Javnost čita, Admin piše
    match /brands/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /categories/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /spec_keys/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ostalo zaključaj
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
